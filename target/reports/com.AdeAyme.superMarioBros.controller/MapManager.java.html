<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MapManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">my-app</a> &gt; <a href="index.source.html" class="el_package">com.AdeAyme.superMarioBros.controller</a> &gt; <span class="el_source">MapManager.java</span></div><h1>MapManager.java</h1><pre class="source lang-java linenums">package com.AdeAyme.superMarioBros.controller;

import com.AdeAyme.superMarioBros.model.GameObject;
import com.AdeAyme.superMarioBros.model.Map;
import com.AdeAyme.superMarioBros.model.brick.Brick;
import com.AdeAyme.superMarioBros.model.brick.OrdinaryBrick;
import com.AdeAyme.superMarioBros.model.enemy.Enemy;
import com.AdeAyme.superMarioBros.model.hero.Fireball;
import com.AdeAyme.superMarioBros.model.hero.Mario;
import com.AdeAyme.superMarioBros.model.prize.BoostItem;
import com.AdeAyme.superMarioBros.model.prize.Coin;
import com.AdeAyme.superMarioBros.model.prize.Prize;
import com.AdeAyme.superMarioBros.view.ImageLoader;

import java.awt.*;
import java.util.ArrayList;

public class MapManager {

    private Map map;
    private Difficulty difficulty;

<span class="fc" id="L23">    public MapManager() {</span>

<span class="fc" id="L25">        difficulty = new Difficulty();</span>
<span class="fc" id="L26">    }</span>

    public void updateLocations() {
<span class="nc bnc" id="L29" title="All 2 branches missed.">        if (map == null)</span>
<span class="nc" id="L30">            return;</span>

<span class="nc" id="L32">        map.updateLocations();</span>
<span class="nc" id="L33">    }</span>

    public void resetCurrentMap(GameEngine engine) {
<span class="nc" id="L36">        Mario mario = getMario();</span>
<span class="nc" id="L37">        mario.resetLocation();</span>
<span class="nc" id="L38">        engine.resetCamera();</span>
<span class="nc" id="L39">        createMap(engine.getImageLoader(), map.getPath());</span>
<span class="nc" id="L40">        map.setMario(mario);</span>
<span class="nc" id="L41">    }</span>

    public boolean createMap(ImageLoader loader, String path) {
<span class="fc" id="L44">        MapCreator mapCreator = new MapCreator(loader, difficulty);</span>
<span class="fc" id="L45">        map = mapCreator.createMap(&quot;/maps/&quot; + path, 400);</span>

<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        return map != null;</span>
    }

    public void acquirePoints(int point) {
<span class="nc" id="L51">        map.getMario().acquirePoints(point);</span>
<span class="nc" id="L52">    }</span>

    public Mario getMario() {
<span class="fc" id="L55">        return map.getMario();</span>
    }

    public void fire(GameEngine engine) {
<span class="nc" id="L59">        Fireball fireball = getMario().fire();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (fireball != null) {</span>
<span class="nc" id="L61">            map.addFireball(fireball);</span>
<span class="nc" id="L62">            engine.playFireball(); //es el sonido del fuego</span>
        }
<span class="nc" id="L64">    }</span>

    public boolean isGameOver() {
<span class="nc bnc" id="L67" title="All 4 branches missed.">        return getMario().getRemainingLives() == 0 || map.isTimeOver();</span>
    }

    public int getScore() {
<span class="nc" id="L71">        return getMario().getPoints();</span>
    }

    public int getRemainingLives() {
<span class="nc" id="L75">        return getMario().getRemainingLives();</span>
    }

    public int getCoins() {
<span class="nc" id="L79">        return getMario().getCoins();</span>
    }

    public void drawMap(Graphics2D g2) {
<span class="nc" id="L83">        map.drawMap(g2);</span>
<span class="nc" id="L84">    }</span>

    public int passMission() {
<span class="nc bnc" id="L87" title="All 4 branches missed.">        if(getMario().getX() &gt;= map.getEndPoint().getX() &amp;&amp; !map.getEndPoint().isTouched()){</span>
<span class="nc" id="L88">            map.getEndPoint().setTouched(true);</span>
<span class="nc" id="L89">            int height = (int)getMario().getY();</span>
<span class="nc" id="L90">            return height * 2;</span>
        }
        else
<span class="nc" id="L93">            return -1;</span>
    }

    public boolean endLevel(){
<span class="nc bnc" id="L97" title="All 2 branches missed.">        return getMario().getX() &gt;= map.getEndPoint().getX() + 320;</span>
    }

    public void checkCollisions(GameEngine engine) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (map == null) {</span>
<span class="nc" id="L102">            return;</span>
        }

<span class="nc" id="L105">        checkBottomCollisions(engine);</span>
<span class="nc" id="L106">        checkTopCollisions(engine);</span>
<span class="nc" id="L107">        checkMarioHorizontalCollision(engine);</span>
<span class="nc" id="L108">        checkEnemyCollisions();</span>
<span class="nc" id="L109">        checkPrizeCollision();</span>
<span class="nc" id="L110">        checkPrizeContact(engine);</span>
<span class="nc" id="L111">        checkFireballContact();</span>
<span class="nc" id="L112">    }</span>

    private void checkBottomCollisions(GameEngine engine) {
<span class="nc" id="L115">        Mario mario = getMario();</span>
<span class="nc" id="L116">        ArrayList&lt;Brick&gt; bricks = map.getAllBricks();</span>
<span class="nc" id="L117">        ArrayList&lt;Enemy&gt; enemies = map.getEnemies();</span>
<span class="nc" id="L118">        ArrayList&lt;GameObject&gt; toBeRemoved = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L120">        Rectangle marioBottomBounds = mario.getBottomBounds();</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (!mario.isJumping())</span>
<span class="nc" id="L123">            mario.setFalling(true);</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">        for (Brick brick : bricks) {</span>
<span class="nc" id="L126">            Rectangle brickTopBounds = brick.getTopBounds();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (marioBottomBounds.intersects(brickTopBounds)) {</span>
<span class="nc" id="L128">                mario.setY(brick.getY() - mario.getDimension().height + 1);</span>
<span class="nc" id="L129">                mario.setFalling(false);</span>
<span class="nc" id="L130">                mario.setVelY(0);</span>
            }
        }

<span class="nc bnc" id="L134" title="All 2 branches missed.">        for (Enemy enemy : enemies) {</span>
<span class="nc" id="L135">            Rectangle enemyTopBounds = enemy.getTopBounds();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (marioBottomBounds.intersects(enemyTopBounds)) {</span>
<span class="nc" id="L137">                mario.acquirePoints(100);</span>
<span class="nc" id="L138">                toBeRemoved.add(enemy);</span>
<span class="nc" id="L139">                engine.playStomp();</span>
            }
        }

<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (mario.getY() + mario.getDimension().height &gt;= map.getBottomBorder()) {</span>
<span class="nc" id="L144">            mario.setY(map.getBottomBorder() - mario.getDimension().height);</span>
<span class="nc" id="L145">            mario.setFalling(false);</span>
<span class="nc" id="L146">            mario.setVelY(0);</span>
        }

<span class="nc" id="L149">        removeObjects(toBeRemoved);</span>
<span class="nc" id="L150">    }</span>

    private void checkTopCollisions(GameEngine engine) {
<span class="nc" id="L153">        Mario mario = getMario();</span>
<span class="nc" id="L154">        ArrayList&lt;Brick&gt; bricks = map.getAllBricks();</span>

<span class="nc" id="L156">        Rectangle marioTopBounds = mario.getTopBounds();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (Brick brick : bricks) {</span>
<span class="nc" id="L158">            Rectangle brickBottomBounds = brick.getBottomBounds();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (marioTopBounds.intersects(brickBottomBounds)) {</span>
<span class="nc" id="L160">                mario.setVelY(0);</span>
<span class="nc" id="L161">                mario.setY(brick.getY() + brick.getDimension().height);</span>
<span class="nc" id="L162">                Prize prize = brick.reveal(engine);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                if(prize != null)</span>
<span class="nc" id="L164">                    map.addRevealedPrize(prize);</span>
            }
        }
<span class="nc" id="L167">    }</span>

    private void checkMarioHorizontalCollision(GameEngine engine){
<span class="nc" id="L170">        Mario mario = getMario();</span>
<span class="nc" id="L171">        ArrayList&lt;Brick&gt; bricks = map.getAllBricks();</span>
<span class="nc" id="L172">        ArrayList&lt;Enemy&gt; enemies = map.getEnemies();</span>
<span class="nc" id="L173">        ArrayList&lt;GameObject&gt; toBeRemoved = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L175">        boolean marioDies = false;</span>
<span class="nc" id="L176">        boolean toRight = mario.getToRight();</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        Rectangle marioBounds = toRight ? mario.getRightBounds() : mario.getLeftBounds();</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">        for (Brick brick : bricks) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            Rectangle brickBounds = !toRight ? brick.getRightBounds() : brick.getLeftBounds();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (marioBounds.intersects(brickBounds)) {</span>
<span class="nc" id="L183">                mario.setVelX(0);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                if(toRight)</span>
<span class="nc" id="L185">                    mario.setX(brick.getX() - mario.getDimension().width);</span>
                else
<span class="nc" id="L187">                    mario.setX(brick.getX() + brick.getDimension().width);</span>
            }
        }

<span class="nc bnc" id="L191" title="All 2 branches missed.">        for(Enemy enemy : enemies){</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            Rectangle enemyBounds = !toRight ? enemy.getRightBounds() : enemy.getLeftBounds();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (marioBounds.intersects(enemyBounds)) {</span>
<span class="nc" id="L194">                marioDies = mario.onTouchEnemy(engine , difficulty );</span>
<span class="nc" id="L195">                toBeRemoved.add(enemy);</span>
            }
        }
<span class="nc" id="L198">        removeObjects(toBeRemoved);</span>


<span class="nc bnc" id="L201" title="All 4 branches missed.">        if (mario.getX() &lt;= engine.getCameraLocation().getX() &amp;&amp; mario.getVelX() &lt; 0) {</span>
<span class="nc" id="L202">            mario.setVelX(0);</span>
<span class="nc" id="L203">            mario.setX(engine.getCameraLocation().getX());</span>
        }

<span class="nc bnc" id="L206" title="All 2 branches missed.">        if(marioDies) {</span>
<span class="nc" id="L207">            resetCurrentMap(engine);</span>
        }
<span class="nc" id="L209">    }</span>

    private void checkEnemyCollisions() {
<span class="nc" id="L212">        ArrayList&lt;Brick&gt; bricks = map.getAllBricks();</span>
<span class="nc" id="L213">        ArrayList&lt;Enemy&gt; enemies = map.getEnemies();</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">        for (Enemy enemy : enemies) {</span>
<span class="nc" id="L216">            boolean standsOnBrick = false;</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">            for (Brick brick : bricks) {</span>
<span class="nc" id="L219">                Rectangle enemyBounds = enemy.getLeftBounds();</span>
<span class="nc" id="L220">                Rectangle brickBounds = brick.getRightBounds();</span>

<span class="nc" id="L222">                Rectangle enemyBottomBounds = enemy.getBottomBounds();</span>
<span class="nc" id="L223">                Rectangle brickTopBounds = brick.getTopBounds();</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">                if (enemy.getVelX() &gt; 0) {</span>
<span class="nc" id="L226">                    enemyBounds = enemy.getRightBounds();</span>
<span class="nc" id="L227">                    brickBounds = brick.getLeftBounds();</span>
                }

<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (enemyBounds.intersects(brickBounds)) {</span>
<span class="nc" id="L231">                    enemy.setVelX(-enemy.getVelX());</span>
                }

<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (enemyBottomBounds.intersects(brickTopBounds)){</span>
<span class="nc" id="L235">                    enemy.setFalling(false);</span>
<span class="nc" id="L236">                    enemy.setVelY(0);</span>
<span class="nc" id="L237">                    enemy.setY(brick.getY()-enemy.getDimension().height);</span>
<span class="nc" id="L238">                    standsOnBrick = true;</span>
                }
            }

<span class="nc bnc" id="L242" title="All 2 branches missed.">            if(enemy.getY() + enemy.getDimension().height &gt; map.getBottomBorder()){</span>
<span class="nc" id="L243">                enemy.setFalling(false);</span>
<span class="nc" id="L244">                enemy.setVelY(0);</span>
<span class="nc" id="L245">                enemy.setY(map.getBottomBorder()-enemy.getDimension().height);</span>
            }

<span class="nc bnc" id="L248" title="All 4 branches missed.">            if (!standsOnBrick &amp;&amp; enemy.getY() &lt; map.getBottomBorder()){</span>
<span class="nc" id="L249">                enemy.setFalling(true);</span>
            }
        }
<span class="nc" id="L252">    }</span>

    private void checkPrizeCollision() {
<span class="nc" id="L255">        ArrayList&lt;Prize&gt; prizes = map.getRevealedPrizes();</span>
<span class="nc" id="L256">        ArrayList&lt;Brick&gt; bricks = map.getAllBricks();</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (Prize prize : prizes) {</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (prize instanceof BoostItem) {</span>
<span class="nc" id="L260">                BoostItem boost = (BoostItem) prize;</span>
<span class="nc" id="L261">                Rectangle prizeBottomBounds = boost.getBottomBounds();</span>
<span class="nc" id="L262">                Rectangle prizeRightBounds = boost.getRightBounds();</span>
<span class="nc" id="L263">                Rectangle prizeLeftBounds = boost.getLeftBounds();</span>
<span class="nc" id="L264">                boost.setFalling(true);</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">                for (Brick brick : bricks) {</span>
                    Rectangle brickBounds;

<span class="nc bnc" id="L269" title="All 2 branches missed.">                    if (boost.isFalling()) {</span>
<span class="nc" id="L270">                        brickBounds = brick.getTopBounds();</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">                        if (brickBounds.intersects(prizeBottomBounds)) {</span>
<span class="nc" id="L273">                            boost.setFalling(false);</span>
<span class="nc" id="L274">                            boost.setVelY(0);</span>
<span class="nc" id="L275">                            boost.setY(brick.getY() - boost.getDimension().height + 1);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                            if (boost.getVelX() == 0)</span>
<span class="nc" id="L277">                                boost.setVelX(2);</span>
                        }
                    }

<span class="nc bnc" id="L281" title="All 2 branches missed.">                    if (boost.getVelX() &gt; 0) {</span>
<span class="nc" id="L282">                        brickBounds = brick.getLeftBounds();</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">                        if (brickBounds.intersects(prizeRightBounds)) {</span>
<span class="nc" id="L285">                            boost.setVelX(-boost.getVelX());</span>
                        }
<span class="nc bnc" id="L287" title="All 2 branches missed.">                    } else if (boost.getVelX() &lt; 0) {</span>
<span class="nc" id="L288">                        brickBounds = brick.getRightBounds();</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">                        if (brickBounds.intersects(prizeLeftBounds)) {</span>
<span class="nc" id="L291">                            boost.setVelX(-boost.getVelX());</span>
                        }
                    }
                }

<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (boost.getY() + boost.getDimension().height &gt; map.getBottomBorder()) {</span>
<span class="nc" id="L297">                    boost.setFalling(false);</span>
<span class="nc" id="L298">                    boost.setVelY(0);</span>
<span class="nc" id="L299">                    boost.setY(map.getBottomBorder() - boost.getDimension().height);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                    if (boost.getVelX() == 0)</span>
<span class="nc" id="L301">                        boost.setVelX(2);</span>
                }

            }
        }
<span class="nc" id="L306">    }</span>

    private void checkPrizeContact(GameEngine engine) {
<span class="nc" id="L309">        ArrayList&lt;Prize&gt; prizes = map.getRevealedPrizes();</span>
<span class="nc" id="L310">        ArrayList&lt;GameObject&gt; toBeRemoved = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L312">        Rectangle marioBounds = getMario().getBounds();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        for(Prize prize : prizes){</span>
<span class="nc" id="L314">            Rectangle prizeBounds = prize.getBounds();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (prizeBounds.intersects(marioBounds)) {</span>
<span class="nc" id="L316">                prize.onTouch(getMario(), engine);</span>
<span class="nc" id="L317">                toBeRemoved.add((GameObject) prize);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            } else if(prize instanceof Coin){</span>
<span class="nc" id="L319">                prize.onTouch(getMario(), engine);</span>
            }
        }

<span class="nc" id="L323">        removeObjects(toBeRemoved);</span>
<span class="nc" id="L324">    }</span>

    private void checkFireballContact() {
<span class="nc" id="L327">        ArrayList&lt;Fireball&gt; fireballs = map.getFireballs();</span>
<span class="nc" id="L328">        ArrayList&lt;Enemy&gt; enemies = map.getEnemies();</span>
<span class="nc" id="L329">        ArrayList&lt;Brick&gt; bricks = map.getAllBricks();</span>
<span class="nc" id="L330">        ArrayList&lt;GameObject&gt; toBeRemoved = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L332" title="All 2 branches missed.">        for(Fireball fireball : fireballs){</span>
<span class="nc" id="L333">            Rectangle fireballBounds = fireball.getBounds();</span>

<span class="nc bnc" id="L335" title="All 2 branches missed.">            for(Enemy enemy : enemies){</span>
<span class="nc" id="L336">                Rectangle enemyBounds = enemy.getBounds();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                if (fireballBounds.intersects(enemyBounds)) {</span>
<span class="nc" id="L338">                    acquirePoints(100);</span>
<span class="nc" id="L339">                    toBeRemoved.add(enemy);</span>
<span class="nc" id="L340">                    toBeRemoved.add(fireball);</span>
                }
            }

<span class="nc bnc" id="L344" title="All 2 branches missed.">            for(Brick brick : bricks){</span>
<span class="nc" id="L345">                Rectangle brickBounds = brick.getBounds();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                if (fireballBounds.intersects(brickBounds)) {</span>
<span class="nc" id="L347">                    toBeRemoved.add(fireball);</span>
                }
            }
        }

<span class="nc" id="L352">        removeObjects(toBeRemoved);</span>
<span class="nc" id="L353">    }</span>

    private void removeObjects(ArrayList&lt;GameObject&gt; list){
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if(list == null)</span>
<span class="nc" id="L357">            return;</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">        for(GameObject object : list){</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if(object instanceof Fireball){</span>
<span class="nc" id="L361">                map.removeFireball((Fireball)object);</span>
<span class="nc" id="L362">            }</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            else if(object instanceof Enemy){</span>
<span class="nc" id="L364">                map.removeEnemy((Enemy)object);</span>
<span class="nc" id="L365">            }</span>
<span class="nc bnc" id="L366" title="All 4 branches missed.">            else if(object instanceof Coin || object instanceof BoostItem){</span>
<span class="nc" id="L367">                map.removePrize((Prize)object);</span>
            }
        }
<span class="nc" id="L370">    }</span>

    public void addRevealedBrick(OrdinaryBrick ordinaryBrick) {
<span class="nc" id="L373">        map.addRevealedBrick(ordinaryBrick);</span>
<span class="nc" id="L374">    }</span>

    public void updateTime(){
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if(map != null)</span>
<span class="nc" id="L378">            map.updateTime(1);</span>
<span class="nc" id="L379">    }</span>

    public int getRemainingTime() {
<span class="nc" id="L382">        return (int)map.getRemainingTime();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>